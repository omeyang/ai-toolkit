# 风险判定矩阵

本文档定义代码审查发现的风险等级标准、语言特定的默认映射和上下文豁免规则。

---

## 四级风险定义

### Critical — 必须立即修复

**定义:** 可直接导致安全漏洞、数据丢失、服务宕机或生产事故的问题。

**典型后果:**
- 数据泄露（用户信息、凭证）
- 远程代码执行
- 服务崩溃或不可恢复的状态损坏
- 资金损失

**处置方式:** 阻塞合并。必须在当前 PR/提交中修复，不接受"后续修复"。

### High — 应当尽快修复

**定义:** 可能导致功能异常、性能严重下降或安全风险的问题，但不会立即造成灾难性后果。

**典型后果:**
- 特定条件下的功能异常
- 性能下降影响用户体验
- 资源泄漏（长时间运行后显现）
- 可被利用但需要特定条件的安全问题

**处置方式:** 强烈建议在当前 PR 中修复。如果确实无法立即修复，必须创建高优先级 Issue 跟踪。

### Medium — 建议修复

**定义:** 影响代码质量、可维护性或存在潜在风险，但当前不会直接导致问题。

**典型后果:**
- 代码可读性下降
- 增加未来维护成本
- 违反团队规范或最佳实践
- 潜在的边界条件问题

**处置方式:** 建议在当前 PR 中修复。可以选择创建 Issue 后续处理。

### Low — 可选改进

**定义:** 风格偏好、微小优化、非关键改进。

**典型后果:**
- 轻微的代码风格不一致
- 微小的性能提升空间
- 次要的文档缺失

**处置方式:** 作为建议提供，不阻塞合并。开发者可自行决定是否修复。

---

## 语言特定风险映射表

### Go 默认风险映射

| 检查项 | 默认等级 | 说明 |
|--------|---------|------|
| goroutine 泄漏 | Critical | 长期运行服务可导致 OOM |
| 并发 map 读写 | Critical | 直接 panic，无法 recover |
| 裸 HTTP client | High | 无超时可导致连接耗尽 |
| recover 吞 panic | High | 隐藏严重错误 |
| context 误用 | High | 破坏取消传播链 |
| 错误包装缺失 | Medium | 影响调试但不影响功能 |
| defer 在循环中 | Medium | 潜在资源泄漏 |
| 接口过大 | Low | 设计偏好 |
| 导出标识符无文档 | Low | 文档质量 |

### Python 默认风险映射

| 检查项 | 默认等级 | 说明 |
|--------|---------|------|
| eval/exec 注入 | Critical | 任意代码执行 |
| subprocess shell=True | Critical | 命令注入 |
| pickle 反序列化 | Critical | 任意代码执行 |
| bare except | High | 吞掉系统信号 |
| assert 用于校验 | High | 生产环境被移除 |
| 可变默认参数 | Medium | 微妙 bug |
| 缺少类型注解 | Low | 代码质量 |

### Shell 默认风险映射

| 检查项 | 默认等级 | 说明 |
|--------|---------|------|
| 缺少 set -euo pipefail | High | 错误静默继续 |
| 变量未加引号 | High | 分词导致意外行为 |
| 命令注入 (eval) | Critical | 任意命令执行 |
| curl\|bash | Critical | 远程代码执行 |
| 临时文件不安全 | High | symlink 攻击 |
| 不可移植语法 | Medium | 跨平台问题 |
| 函数未声明 local | Low | 变量污染 |

---

## 上下文豁免规则

以下情况可将发现的风险等级**降低一级**（但 Critical 最多降至 High）：

### 文件类型豁免

| 上下文 | 可豁免项 | 降级理由 |
|--------|---------|---------|
| `*_test.go` / `test_*.py` / `*_test.sh` | eval/exec 使用、bare except、硬编码凭证（明显的测试值如 `test-token`）| 测试文件不在生产运行 |
| `cmd/*/main.go`（CLI 工具）| goroutine 泄漏（短生命周期进程）| 进程退出即回收 |
| `scripts/`、`tools/` 目录 | set -euo pipefail 缺失、临时文件 | 运维脚本通常有人工监控 |
| `internal/` 目录 | 缺少输入验证 | 内部包不直接暴露给外部输入 |
| `examples/`、`demo/` 目录 | 大部分 B/C 级检查项 | 示例代码优先可读性 |

### 项目类型豁免

| 项目类型 | 可豁免项 | 判断依据 |
|---------|---------|---------|
| 原型/实验项目 | 所有 C 级、部分 B 级 | `README` 标注实验性 或 版本 < 1.0 |
| 长期运行服务 | 无豁免 | goroutine 泄漏、资源泄漏不可降级 |
| 一次性脚本 | 信号处理、函数文档 | 明确标注为一次性用途 |

### 豁免记录要求

应用豁免时必须在报告中说明：
```markdown
- **风险等级:** Medium (原 High，因测试文件豁免降级)
- **豁免理由:** 文件 `service_test.go` 中的测试用硬编码 token 不会出现在生产代码中
```

---

## 自动修复阈值

以下情况建议直接提供修复代码（而不仅仅是描述问题）：

| 条件 | 说明 |
|------|------|
| 修复是确定性的（唯一正确答案）| 如：添加 `"$var"` 引号、添加 `err` 检查 |
| 修复不超过 5 行 | 如：添加 `defer f.Close()`、设置 HTTP timeout |
| 修复不涉及架构决策 | 如：简单的 nil 检查，不涉及错误处理策略选择 |

不建议自动修复的情况：
- 涉及架构选择（如选择哪种缓存策略）
- 修复影响范围大（需要重构）
- 需要领域知识（业务逻辑相关）
