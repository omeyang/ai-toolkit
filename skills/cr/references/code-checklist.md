# 代码检查清单

按 A/B/C 优先级组织。A 级为阻塞项（必须修复），B 级为重要项（应当修复），C 级为建议项（可选改进）。

---

## 通用检查项（所有语言）

### A 级（阻塞）

- **[A-GEN-01] 明文凭证** — 代码中硬编码密码、API Key、Token、私钥。检查字符串字面值、配置默认值。
- **[A-GEN-02] 路径遍历** — 用户输入拼接文件路径，未做清理或限制基目录。检查 `../` 和绝对路径注入。
- **[A-GEN-03] 错误返回值忽略** — 函数返回错误但调用方未检查。重点关注 I/O、网络、数据库操作。
- **[A-GEN-04] 资源未释放** — 打开的文件、网络连接、数据库连接、锁未在所有路径上释放。
- **[A-GEN-05] 命令注入** — 用户输入直接拼接到系统命令中，未做转义或使用参数化。
- **[A-GEN-06] SQL/NoSQL 注入** — 用户输入直接拼接到查询语句中，未使用参数化查询。
- **[A-GEN-07] 敏感数据日志泄露** — 将密码、Token、PII 等写入日志。

### B 级（重要）

- **[B-GEN-01] 缺少超时** — 外部调用（HTTP、RPC、数据库）无超时设置，可能导致调用方挂起。
- **[B-GEN-02] 错误信息泄露** — 错误响应中包含内部堆栈、文件路径、SQL 语句等实现细节。
- **[B-GEN-03] 缺少输入验证** — 外部输入（HTTP 参数、消息体、环境变量）未做类型/范围/长度校验。
- **[B-GEN-04] 不安全的随机数** — 安全场景（Token、密钥、nonce）使用非密码学安全的随机数生成器。
- **[B-GEN-05] 缺少访问控制** — API 端点或操作缺少认证/授权检查。
- **[B-GEN-06] 竞态条件** — 共享状态的并发读写无同步保护。

### C 级（建议）

- **[C-GEN-01] 魔法数字** — 代码中直接使用未命名的数字常量。
- **[C-GEN-02] 过深嵌套** — 超过 3 层嵌套的条件/循环，影响可读性。
- **[C-GEN-03] 重复代码** — 明显的复制粘贴代码块（>10 行相似）。
- **[C-GEN-04] 过长函数** — 单个函数超过 80 行（不含注释和空行）。

---

## Go 专项

> Go 惯用法和代码规范的完整参考见 `skills/go-style/SKILL.md`，此处仅列出审查检查项，不重复其内容。

### A 级（阻塞）

- **[A-GO-01] goroutine 泄漏** — 启动的 goroutine 无退出机制（缺少 context 取消、done channel 或超时）。
- **[A-GO-02] 并发 map 读写** — 对 `map` 的并发读写未使用 `sync.Mutex` 或 `sync.Map`，会导致 panic。
- **[A-GO-03] 裸 HTTP client** — 使用 `http.DefaultClient` 或未设置 Timeout 的 `&http.Client{}`。
- **[A-GO-04] recover 吞 panic** — `recover()` 捕获 panic 后未记录日志或上报，静默吞掉错误。
- **[A-GO-05] context 误用** — 将 context 存储在 struct 中；使用 `context.Background()` 替代传入的 ctx。

### B 级（重要）

- **[B-GO-01] 错误包装缺失** — 返回错误时未使用 `fmt.Errorf("...: %w", err)` 包装，丢失上下文。
- **[B-GO-02] defer 在循环中** — 在循环体内使用 `defer`，资源延迟到函数退出才释放。
- **[B-GO-03] 接口过大** — 定义了超过 5 个方法的接口，违反最小接口原则。
- **[B-GO-04] 未预分配 slice** — 已知长度时未使用 `make([]T, 0, n)` 预分配。
- **[B-GO-05] time.After 在循环中** — `time.After` 在循环内使用导致 timer 泄漏。

### C 级（建议）

- **[C-GO-01] 导出标识符无文档** — 公开的类型、函数、常量缺少 godoc 注释。
- **[C-GO-02] init() 函数** — 使用 `init()` 且有副作用（I/O、网络），影响测试隔离。
- **[C-GO-03] 空接口参数** — 函数参数类型为 `interface{}`/`any`，缺少类型约束。

---

## Python 专项

### A 级（阻塞）

- **[A-PY-01] eval/exec 注入** — 对用户输入使用 `eval()`、`exec()`、`compile()`。
- **[A-PY-02] subprocess shell=True** — `subprocess.run/Popen` 使用 `shell=True` 且参数含用户输入。
- **[A-PY-03] pickle 反序列化** — 对不可信数据使用 `pickle.loads()`，可导致任意代码执行。
- **[A-PY-04] bare except** — 使用 `except:` 或 `except Exception:` 捕获所有异常，包括 `KeyboardInterrupt`、`SystemExit`。
- **[A-PY-05] assert 用于校验** — 生产代码中使用 `assert` 做输入校验（`-O` 模式下会被移除）。

### B 级（重要）

- **[B-PY-01] 可变默认参数** — 函数参数默认值为可变对象（`def f(x=[])`），多次调用共享状态。
- **[B-PY-02] 缺少类型注解** — 公开函数/方法缺少参数和返回值类型注解。
- **[B-PY-03] f-string 中的复杂表达式** — f-string 内嵌复杂逻辑或函数调用，影响可读性。
- **[B-PY-04] 全局可变状态** — 模块级可变变量被多处修改。
- **[B-PY-05] 资源未用 with** — 文件/连接等资源未使用 `with` 上下文管理器。

### C 级（建议）

- **[C-PY-01] 过长导入列表** — 单个模块导入超过 10 个名称，考虑使用 `import module`。
- **[C-PY-02] 字符串拼接** — 在循环中使用 `+=` 拼接字符串，应使用 `join()` 或 `io.StringIO`。
- **[C-PY-03] 嵌套推导式** — 超过 2 层的列表/字典推导式，影响可读性。

---

## Shell 专项

### A 级（阻塞）

- **[A-SH-01] 缺少 set 选项** — 脚本未设置 `set -euo pipefail`（或等效的错误处理策略）。
- **[A-SH-02] 变量未加引号** — 变量展开未加双引号（`$var` 而非 `"$var"`），导致分词和通配符展开。
- **[A-SH-03] 命令注入** — 用户输入直接传入 `eval`、`$()`、反引号中。
- **[A-SH-04] curl|bash** — 从网络下载并直接执行脚本，无完整性校验。
- **[A-SH-05] 临时文件不安全** — 使用固定路径创建临时文件（`/tmp/myapp.tmp`），存在 symlink 攻击风险。应使用 `mktemp`。

### B 级（重要）

- **[B-SH-01] 缺少错误处理** — 关键命令执行后未检查返回值（`$?`）。
- **[B-SH-02] 不可移植语法** — 使用 bash 特有语法但 shebang 为 `#!/bin/sh`。
- **[B-SH-03] 环境变量未校验** — 依赖环境变量但未检查是否已设置（使用 `${VAR:?msg}`）。
- **[B-SH-04] 信号处理缺失** — 长时间运行的脚本未设置 `trap` 处理 SIGTERM/SIGINT。
- **[B-SH-05] 日志输出混乱** — 调试输出到 stdout 而非 stderr，影响管道使用。

### C 级（建议）

- **[C-SH-01] 函数未声明 local** — 函数内变量未使用 `local` 声明，污染全局作用域。
- **[C-SH-02] 过长管道** — 超过 4 段的管道命令，考虑拆分为中间变量。
- **[C-SH-03] 硬编码路径** — 使用绝对路径而非相对路径或变量，降低可移植性。
